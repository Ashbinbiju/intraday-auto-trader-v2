# Supabase Integration Plan & Setup Guide

## ‚ö†Ô∏è Why This is Critical
If you deploy to **Render** (or any cloud platform), your local files (`bot_state.json`, [config.json](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/config.json)) appear to be saved, but they are **wiped clean** every time the server restarts or re-deploys.

**Without Supabase/Database:**
- You lose all active positions on restart.
- You lose your settings tweaks.
- You lose your trade history.

**With Supabase:**
- Your bot has a permanent memory.
- You can restart/redeploy safely.
- You can access data from anywhere (phone/web).

---

## üõ†Ô∏è Step 1: Create Supabase Project (User Action Required)

1.  **Go to [Supabase](https://supabase.com/)** and Sign Up / Log In.
2.  Click **"New Project"**.
3.  Name it: `intraday-bot` (or anything you like).
4.  Set a strong database password.
5.  Choose a region close to your server (e.g., Mumbai/Singapore).
6.  Click **"Create New Project"**.

### Get Credentials
Once the project is ready (takes ~1 min):
1.  Go to **Project Settings** (gear icon) -> **API**.
2.  Find **Project URL** (e.g., `https://xyz.supabase.co`).
3.  Find **Project API Keys** -> `anon` / `public`.

> **You will need to provide me with:**
> 1. `SUPABASE_URL`
> 2. `SUPABASE_KEY` (the public anon key)

---

## üóÑÔ∏è Step 2: Create Database Tables (Run in SQL Editor)

Go to the **SQL Editor** in Supabase and run this script to set up the tables:

```sql
-- 1. Table for Bot Configuration
create table if not exists bot_config (
  id text primary key default 'global',
  data jsonb not null,
  updated_at timestamptz default now()
);

-- 2. Table for Bot State (active positions, market memory)
create table if not exists bot_state (
  id text primary key default 'global',
  data jsonb not null,
  updated_at timestamptz default now()
);

-- 3. Table for Trade History (Permanent Logs)
create table if not exists trade_history (
  id uuid primary key default gen_random_uuid(),
  symbol text not null,
  entry_price numeric,
  exit_price numeric,
  qty int,
  pnl numeric,
  status text, -- 'OPEN', 'CLOSED', 'REJECTED'
  entry_time timestamptz,
  exit_time timestamptz,
  metadata jsonb -- Extra details like SL, TP, reasons
);

-- 4. Enable Row Level Security (good practice)
alter table bot_config enable row level security;
alter table bot_state enable row level security;
alter table trade_history enable row level security;

-- 5. Open Access Policy (Simplest for single-user bot)
create policy "Public Access" on bot_config for all using (true);
create policy "Public Access" on bot_state for all using (true);
create policy "Public Access" on trade_history for all using (true);
```

---

## üíª Step 3: Implementation Plan (My Action)

Once you provide the credentials, I will:

### 1. Update Requirements
Add `supabase` to [requirements.txt](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/requirements.txt).

### 2. Create `database.py` Module
This new file will handle all DB interactions.

```python
from supabase import create_client, Client
import os

url = os.environ.get("SUPABASE_URL")
key = os.environ.get("SUPABASE_KEY")
supabase: Client = create_client(url, key)

def get_config():
    # Fetch from DB, fallback to default local
    pass

def save_config(config_data):
    # Upsert to DB
    pass

def get_state():
    # Fetch bot state (positions)
    pass
    
def save_state(state_data):
    # Save active positions
    pass
```

### 3. Refactor `state_manager.py`
Modify it to verify if Supabase is configured; if so, use `database.py`. If not, fall back to local [json](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/config.json) files (for local testing).

### 4. Refactor [api.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/api.py) & [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py)
Ensure they initialize the database connection on startup.

---

## üöÄ Ready?
Please provide the **URL** and **KEY** when you are ready, and I will integrate it immediately.
