# Dynamic Position Sizing Implementation Plan

## Current Issue
- User must manually set `"quantity": 1` in config.json
- Position size doesn't adjust to account balance
- Risk per trade is not controlled relative to capital
- Same quantity used regardless of stock price or stop-loss distance

## Proposed Solution: Dynamic Position Sizing

### Formula
```
Position Size (qty) = (Account Balance Ã— Risk %) / (Entry Price Ã— SL Distance %)
```

**Example:**
- Account Balance: â‚¹100,000
- Risk per trade: 1% = â‚¹1,000
- Entry Price: â‚¹500
- SL Distance: 2% (â‚¹10)

```
Qty = 1000 / 10 = 100 shares
Total Investment = 100 Ã— 500 = â‚¹50,000 (50% of capital)
Risk = 100 Ã— 10 = â‚¹1,000 (1% of capital) âœ…
```

### Configuration Changes

#### config.json
```json
{
  "position_sizing": {
    "mode": "dynamic",  // "fixed" or "dynamic"
    "risk_per_trade_pct": 1.0,  // 1% of account balance
    "max_position_size_pct": 20.0,  // Max 20% of capital per trade
    "paper_trading_balance": 100000  // Virtual balance for dry_run
  },
  "general": {
    "quantity": 1,  // Only used if mode = "fixed"
    "dry_run": true
  }
}
```

### Implementation Steps

#### 1. Add Position Sizing Function
**File:** [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py)

```python
def calculate_position_size(entry_price, sl_price, balance, risk_pct, max_position_pct):
    """
    Calculates dynamic position size based on risk management.
    
    Args:
        entry_price: Entry price for the stock
        sl_price: Stop loss price
        balance: Account balance
        risk_pct: Risk per trade as percentage of balance (e.g., 1.0 for 1%)
        max_position_pct: Max position size as % of balance (e.g., 20.0 for 20%)
    
    Returns:
        int: Quantity to buy (rounded down)
    """
    # Calculate risk amount
    risk_amount = balance * (risk_pct / 100)
    
    # Calculate SL distance per share
    sl_distance = abs(entry_price - sl_price)
    
    # Position size = Risk Amount / SL Distance
    qty = int(risk_amount / sl_distance)
    
    # Enforce max position size
    max_qty = int((balance * max_position_pct / 100) / entry_price)
    qty = min(qty, max_qty)
    
    # Ensure at least 1 share
    qty = max(1, qty)
    
    return qty
```

#### 2. Get Account Balance
**For Paper Trading:**
```python
def get_account_balance(smartApi, dry_run):
    if dry_run:
        # Use configured virtual balance
        return config_manager.get("position_sizing", "paper_trading_balance") or 100000
    
    # For live trading, fetch from Angel One
    try:
        rmsLimit = smartApi.rmsLimit()
        available_balance = rmsLimit['data']['availablecash']
        return float(available_balance)
    except Exception as e:
        logger.error(f"Failed to fetch balance: {e}")
        return 100000  # Fallback
```

#### 3. Integrate into Buy Logic
**Location:** [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py) - Signal processing section

**Before:**
```python
qty = config_manager.get("general", "quantity") or 1
```

**After:**
```python
sizing_mode = config_manager.get("position_sizing", "mode") or "fixed"
if sizing_mode == "dynamic":
    balance = get_account_balance(smartApi, dry_run)
    risk_pct = config_manager.get("position_sizing", "risk_per_trade_pct") or 1.0
    max_pos_pct = config_manager.get("position_sizing", "max_position_size_pct") or 20.0
    qty = calculate_position_size(price, sl_price, balance, risk_pct, max_pos_pct)
else:
    qty = config_manager.get("general", "quantity") or 1

logger.info(f"ðŸ“Š Position Sizing: {qty} shares @ â‚¹{price} | Risk: â‚¹{qty * abs(price - sl_price):.2f}")
```

### Safety Checks

1. **Minimum Quantity:** Always at least 1 share
2. **Maximum Position:** Can't exceed 20% of balance (configurable)
3. **Balance Validation:** If balance fetch fails, use safe default
4. **Dry Run Mode:** Uses `paper_trading_balance` from config

### Benefits

âœ… **Risk Control:** Every trade risks exactly 1% of capital  
âœ… **Account-Aware:** Adapts to available balance  
âœ… **SL-Aware:** Tighter SL = larger position size  
âœ… **Paper Trading Safe:** Uses virtual balance  
âœ… **Backwards Compatible:** Can still use fixed quantity

### Example Scenarios

#### Scenario 1: Tight SL (Good Setup)
- Balance: â‚¹100,000
- Entry: â‚¹500
- SL: â‚¹490 (2% SL, tight!)
- Risk: 1% = â‚¹1,000

```
Qty = 1000 / 10 = 100 shares
Investment = â‚¹50,000
Risk = â‚¹1,000 âœ…
```

#### Scenario 2: Wide SL (Risky Setup)
- Balance: â‚¹100,000
- Entry: â‚¹500
- SL: â‚¹475 (5% SL, wide!)
- Risk: 1% = â‚¹1,000

```
Qty = 1000 / 25 = 40 shares
Investment = â‚¹20,000
Risk = â‚¹1,000 âœ…
```

**Notice:** Wider SL automatically reduces position size!

#### Scenario 3: Expensive Stock
- Balance: â‚¹100,000
- Entry: â‚¹5000
- SL: â‚¹4900 (2% SL)
- Risk: 1% = â‚¹1,000

```
Qty = 1000 / 100 = 10 shares
Investment = â‚¹50,000
Risk = â‚¹1,000 âœ…
```

### Testing Plan

1. âœ… Test with dry_run = true
2. âœ… Verify balance fetch works
3. âœ… Test tight SL â†’ larger qty
4. âœ… Test wide SL â†’ smaller qty
5. âœ… Test max position limit
6. âœ… Test with expensive stocks
7. âœ… Test fallback to fixed mode

### UI Changes

**Settings Page:**
- Add toggle: "Dynamic Position Sizing"
- Add slider: "Risk Per Trade (%)" [0.5% - 2%]
- Add slider: "Max Position Size (%)" [10% - 30%]
- Add input: "Paper Trading Balance" (shown only in dry_run)
- Show calculation preview

### Migration

**Existing users:** Keep `mode: "fixed"` by default  
**New users:** Set `mode: "dynamic"` by default

---

## Ready to Implement?

This design ensures:
- âœ… Consistent risk management
- âœ… Account balance awareness
- âœ… Paper trading compatibility
- âœ… Backwards compatibility
- âœ… Safety limits

**Should I proceed with implementation?**
