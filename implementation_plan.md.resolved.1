# Async Scanner
# Implementation Plan - Intraday Screener Bot v2.0

# Goal Description
Upgrade the existing synchronous bot to a robust, high-performance v2.0 Architecture.
Key Goals:
1.  **V2.0 API**: Replace single-file script with FastAPI backend.
2.  **Persistence**: Ensure bot state survives restarts.
3.  **Real-Time Dashboard**: WebSocket-powered frontend.
4.  **Performance**: Async Scanner for <1m scan times.
5.  **Strategy**: Enhanced Exit Rules (Breakeven, Dual Tech Exit).

## User Review Required
> [!IMPORTANT]
> **Async Scanner** is now active (using `aiohttp`).
> **Exit Rules** are now STRICT (Candle Close only).

## Proposed Changes

### Phase 1: API & Architecture (Complete)
#### [NEW] [api.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/api.py)
- [x] FastAPI Server Setup
- [x] Endpoints for Settings, Trade Mgmt, Logs
- [x] WebSocket Hub

#### [MODIFY] [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py)
- [x] Integrate with API Thread
- [x] Replace `time.sleep` with `asyncio` loop triggers where possible.

### Phase 2: React Frontend (Complete)
#### [NEW] [frontend/](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/frontend/)
- [x] Dashboard (P&L, Win Rate)
- [x] Signals Page (Live Table)
- [x] Settings Page (Form)
- [x] Logs Page (Real-time)
- [x] Mobile Responsive

### Phase 3: Reliability & Performance (Complete)
#### [NEW] [state_manager.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/state_manager.py)
- [x] JSON Backup logic ([bot_state.json](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/bot_state.json)).
- [x] Reconciliation Logic (Broker Sync).

#### [NEW] [async_scanner.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/async_scanner.py)
- [x] `aiohttp` implementation.
- [x] Parallel Fetch & Compute.

### Phase 4: Strategy Enhancements (Complete)
#### [MODIFY] [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py)
- [x] **Strict Candle Close**: Exit only on confirmed candle.
- [x] **Breakeven Lock**: Move SL to Entry after +1R.
- [x] **Dual Tech Exit**: Close < EMA20 AND Close < VWAP.
- [x] **Time Exit**: >60m Stagnation.

## Verification Plan
### Automated Tests
- [x] API Status Check (`/`)
- [x] WebSocket Connection
- [x] Async Scanner Performance (Logs)

### Manual Verification
- [x] Trigger Test Signal -> Check Dashboard.
- [x] Verify Persistence (Restart Server -> Check State).
- [x] Verify Exit Logic (Simulate Price Drop in Logic).

## File Changes

### [NEW] [async_scanner.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/async_scanner.py)
```python
import asyncio
import aiohttp
import logging
from indicators import calculate_indicators, check_buy_condition
from utils import get_ist_now

class AsyncScanner:
    def __init__(self, jwt_token, api_key):
        self.jwt_token = jwt_token
        self.api_key = api_key
        # ... logic ...
```

### [MODIFY] [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py)
- Import [AsyncScanner](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/async_scanner.py#19-138) (or function).
- Initialize [AsyncScanner](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/async_scanner.py#19-138) with session tokens.
- Replace synchronous scanning loop with `await` (or `asyncio.run` wrapper if main is sync).
    - Since [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py) uses `time.sleep` and is fundamentally sync, we can use `asyncio.run(scanner.scan(stocks))` for the specific block.

## Risk Management
- **Rate Limits**: Angel One has limits. 80 concurrent requests might trigger it. We will tune `Semaphore` starting at 20.
- **CPU Bound**: [calculate_indicators](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/indicators.py#3-36) (Pandas) is blocking. With 50 threads, it might lag. If so, we use `loop.run_in_executor`.

## Verification
- Compare Scan Time logs.
- Verify Signal Accuracy (matches [indicators.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/indicators.py) logic).
