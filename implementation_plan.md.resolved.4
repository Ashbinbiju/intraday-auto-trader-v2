# Implementation Plan: Structure-Based Risk Management

## Goal
Replace percentage-based SL/TP with structure-based calculations that respect market dynamics (VWAP, swing levels, resistance) to improve intraday win rate and reduce wick hunting.

## Current Problems
1. **Fixed 1% SL** â†’ Too tight for intraday, gets hunted by normal pullbacks
2. **Fixed 2% TP** â†’ Random number, not aligned with actual resistance levels
3. **No structure validation** â†’ Trades placed regardless of market context

## Proposed Solution

### Phase 1: Structure-Based Stop-Loss âš¡ (High Priority)

#### 1.1 Calculate Dynamic SL
**Location**: [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py) - Buy order section (before placing order)

```python
def calculate_structure_based_sl(df, entry_price, vwap, ema20):
    """
    Calculate SL based on nearest structure.
    Returns: (sl_price, sl_reason)
    """
    buffer_pct = 0.002  # 0.2% buffer
    
    # Option 1: Swing Low (last 5-10 candles)
    recent_candles = df.iloc[-10:]
    swing_low = recent_candles['low'].min()
    swing_low_sl = swing_low * (1 - buffer_pct)
    
    # Option 2: VWAP-based
    vwap_sl = vwap * (1 - buffer_pct)
    
    # Option 3: EMA20-based
    ema20_sl = ema20 * (1 - buffer_pct)
    
    # Pick the HIGHEST (least tight) valid SL below entry
    # BUT with priority weighting to prefer stronger structure
    priority = {
        "Swing Low": 3,  # Strongest - actual market structure
        "VWAP": 2,       # Dynamic support
        "EMA20": 1       # Trend indicator
    }
    
    candidates = [
        (swing_low_sl, "Swing Low"),
        (vwap_sl, "VWAP"),
        (ema20_sl, "EMA20")
    ]
    
    # Filter: Only use SL below entry
    valid_candidates = [(sl, reason) for sl, reason in candidates if sl < entry_price]
    
    if not valid_candidates:
        return None, "No valid structure found"
    
    # Choose by priority FIRST, then by price (closest)
    best_sl, reason = max(valid_candidates, key=lambda x: (priority[x[1]], x[0]))
    
    # Safety Check: Reject if SL > 2% away
    sl_distance_pct = ((entry_price - best_sl) / entry_price) * 100
    if sl_distance_pct > 2.0:
        return None, f"SL too wide ({sl_distance_pct:.1f}%)"
    
    # Safety Check: Reject if SL < 0.8% away (wick risk)
    if sl_distance_pct < 0.8:
        return None, f"SL too tight ({sl_distance_pct:.1f}%) - wick risk"
    
    return best_sl, f"{reason} ({sl_distance_pct:.2f}%)"
```

#### 1.2 Integration Point
- **File**: [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py), lines 555-590 (buy order section)
- **Change**: Before calling [place_buy_order()](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py#71-98), calculate structure-based SL
- **Validation**: If SL is invalid, skip the trade entirely

---

### Phase 2: Structure-Based Take-Profit ðŸŽ¯

#### 2.1 Calculate Dynamic TP
**Location**: [indicators.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/indicators.py) (new function)

```python
def calculate_structure_based_tp(entry_price, sl_price, df, previous_day_high=None):
    """
    Calculate TP based on:
    1. Previous day high
    2. Intraday resistance (recent swing high)
    3. Minimum 1.5R from entry
    
    Returns: (tp_price, tp_reason, risk_reward_ratio)
    """
    risk = entry_price - sl_price
    min_reward = risk * 1.5  # Minimum 1.5R
    min_tp = entry_price + min_reward
    
    candidates = []
    
    # Option 1: Previous Day High (if available)
    if previous_day_high and previous_day_high > entry_price:
        candidates.append((previous_day_high, "PDH"))
    
    # Option 2: Nearest Swing High (last 20 candles)
    recent_candles = df.iloc[-20:]
    swing_high = recent_candles['high'].max()
    # Distance filter: Reject swing highs too close (< 0.6%)
    if swing_high > entry_price:
        distance_pct = ((swing_high - entry_price) / entry_price) * 100
        if distance_pct >= 0.6:  # Minimum 0.6% away
            candidates.append((swing_high, "Swing High"))
    
    # Option 3: 1.5R (Minimum acceptable)
    candidates.append((min_tp, "1.5R Minimum"))
    
    # Filter: Only TPs above entry
    valid_candidates = [(tp, reason) for tp, reason in candidates if tp > entry_price]
    
    if not valid_candidates:
        return None, "No valid target found", 0
    
    # Choose the NEAREST one (most realistic)
    best_tp, reason = min(valid_candidates, key=lambda x: x[0])
    
    # Calculate R:R
    reward = best_tp - entry_price
    rr_ratio = reward / risk if risk > 0 else 0
    
    # Reject if < 1.5R
    if rr_ratio < 1.5:
        return None, f"R:R too low ({rr_ratio:.1f})", rr_ratio
    
    return best_tp, f"{reason} (R:R {rr_ratio:.1f})", rr_ratio
```

#### 2.2 Previous Day High Integration
**Challenge**: Need to fetch PDH data
**Solution**: 
- Option A: Fetch daily candle data on startup
- Option B: Store PDH in [bot_state.json](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/bot_state.json) daily
- Recommended: **Option B** (simpler, faster)

---

### Phase 3: Enhanced Trailing Logic ðŸƒ

#### Already Implemented (Verify):
- Breakeven lock after +1R (line 220-231 in [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py))

#### Additional Enhancement:
Add VWAP/EMA trailing:

```python
# In manage_positions(), after breakeven check:
if pos.get('is_breakeven_active'):
    # Fetch latest VWAP
    df = fetch_candle_data(...)
    current_vwap = df.iloc[-1]['VWAP']
    
    # If price closes BELOW VWAP, exit
    if current_ltp < current_vwap:
        logger.info(f"VWAP Trail Exit: {symbol}")
        place_sell_order(...)
```

---

## Implementation Order

### Step 1: Add Helper Function
- [ ] Create `calculate_structure_based_sl()` in [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py)
- [ ] Create `calculate_structure_based_tp()` in [indicators.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/indicators.py)

### Step 2: Integrate into Buy Flow
- [ ] Modify buy order section (line 555-590)
- [ ] Calculate SL/TP before placing order
- [ ] Add validation: Skip trade if SL/TP invalid
- [ ] Log rejection reasons for analysis

### Step 3: Add PDH Tracking
- [ ] Add `previous_day_high` to `BOT_STATE`
- [ ] Fetch daily candle on startup
- [ ] Update PDH daily at market open

### Step 4: Testing
- [ ] Test with dry_run mode
- [ ] Verify SL/TP calculations for multiple stocks
- [ ] Check rejection logs for false negatives
- [ ] Compare win rate vs old system

### Step 5: Enhanced Trailing (Optional)
- [ ] Add VWAP trailing logic
- [ ] Add 9 EMA trailing option
- [ ] Make configurable via [config.json](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/config.json)

---

## Risk Considerations

> [!IMPORTANT]
> **Backward Compatibility**: Old positions (created before this update) will still use %-based SL/TP.
> Only NEW positions will use structure-based logic.

> [!WARNING]
> **Signal Volume**: More strict SL/TP validation will **reduce signal count**.
> This is intentional - quality over quantity.

> [!CAUTION]
> **Testing Required**: Test in dry_run mode for at least 1 full trading day before going live.

---

## Configuration Changes

Add new section to [config.json](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/config.json):

```json
"structure_risk": {
    "min_sl_distance_pct": 0.8,
    "max_sl_distance_pct": 2.0,
    "sl_buffer_pct": 0.2,
    "min_risk_reward": 1.5,
    "use_structure_based": true  // Toggle for testing
}
```

---

## Verification Plan

1. **Log Analysis**: Check `rejected_trades.log` for:
   - SL too tight rejections
   - SL too wide rejections
   - R:R ratio rejections

2. **Backtest Comparison**:
   - Old system: 1% SL / 2% TP
   - New system: Structure-based
   - Compare win rate, avg profit, max drawdown

3. **Live Monitoring**:
   - First 3 days: Dry run only
   - Days 4-7: Live with 1 trade/day limit
   - Week 2+: Full production if successful
