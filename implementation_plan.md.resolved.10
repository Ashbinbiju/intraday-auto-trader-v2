# Rate Limit Implementation Plan

## Goal
Prevent `403 Access Denied` / `429 Too Many Requests` errors by respecting Angel One's rate limits.

## Critical Limits
| API | Limit (Sec) | Limit (Min) |
|---|---|---|
| `getLtpData` | 10 | 500 |
| `placeOrder` | 9 | 500 |
| `getCandleData` | 3 | 180 (Strict!) |

## Proposed Changes

### 1. [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py) - Position Management Throttling
- **Issue**: [manage_positions](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py#116-180) loops through all active positions and calls `ltpData` immediately. If > 10 positions, it bursts > 10 req/sec.
- **Fix**: Add `time.sleep(0.2)` inside the loop. This caps it at 5 req/sec (Safe).
- **Location**: [manage_positions](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py#116-180) function loop.

### 2. [smart_api_helper.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/smart_api_helper.py) - Robust Retry Logic
- **Issue**: Current retry logic is specific to `AB2001` or `Internal Error`.
- **Fix**: Add a generic decorator or helper `execute_with_retry` that catches `403` or "Rate Limit" strings and retries with exponential backoff.
- **Scope**: Apply this to `ltpData` (if I wrap it) or just ensure [fetch_candle_data](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/smart_api_helper.py#34-94) is robust. Since `ltpData` is called directly on `smartApi` object in [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py), I will wrap it or just handle it in [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py)'s try/except block.
- **Easy Fix**: In [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py), inside [manage_positions](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py#116-180), specific try/catch for "Rate Limit" and sleep if hit. But the `sleep(0.2)` should prevent it proactively.

### 3. [scraper.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/scraper.py) / [main.py](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py) - Scanning Loop
- **Status**: Already has `time.sleep(1.5)` which is ~40 req/min. This is well below the 180/min limit for candles. **No change needed here.**

## Verification
- Dry run with simulated "Rate Limit" error (hard to simulate without mocking).
- Real-time check: With `sleep(0.2)`, [manage_positions](file:///C:/Users/Ashbin/.gemini/antigravity/brain/2df2ed12-f98d-4c89-bf98-dea5fc2acbc3/main.py#116-180) will take 2 seconds for 10 positions. This is acceptable latency.

